<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meet Pro: Full Suite</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #202124; --card: #3c4043; --accent: #8ab4f8; --danger: #ea4335; --voice: #81c995;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: var(--bg); color: white; }
        
        /* –õ–û–ë–ë–ò */
        #lobby { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; gap: 20px; }
        .preview-container { position: relative; width: 480px; height: 270px; background: #000; border-radius: 12px; overflow: hidden; border: 2px solid #5f6368; }
        #preview-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* –ö–û–ú–ù–ê–¢–ê */
        #room { display: none; flex-direction: column; height: 100vh; }
        #video-grid { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; padding: 20px; flex: 1; overflow: auto; }
        
        .video-item { 
            background: #000; border-radius: 12px; overflow: hidden; width: 100%; max-width: 600px; 
            aspect-ratio: 16/9; position: relative; border: 4px solid transparent; transition: 0.3s;
        }
        .video-item video { width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }
        .video-off video { visibility: hidden; }
        .speaking { border-color: var(--voice) !important; box-shadow: 0 0 15px var(--voice); }

        /* –ò–ö–û–ù–ö–ò –°–¢–ê–¢–£–°–ê */
        .status-icons { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; }
        .icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; background: rgba(0,0,0,0.6); }
        .icon-off { background: var(--danger); }

        /* –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .bottom-bar { height: 80px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .btn { width: 50px; height: 50px; border-radius: 50%; border: 1px solid #5f6368; background: #3c4043; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .btn.off { background: var(--danger); border: none; }
        .btn-screen.active { background: var(--accent); color: #202124; }
        .btn-join { background: var(--accent); color: #202124; padding: 12px 40px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; }
        
        .name-tag { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 4px; font-size: 14px; z-index: 10; }
    </style>
</head>
<body>

    <div id="lobby">
        <h2>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–≤–æ–Ω–∫—É</h2>
        <div class="preview-container" id="lobby-box">
            <video id="preview-video" autoplay muted playsinline></video>
            <div class="status-icons">
                <div id="lobby-mic-status" class="icon">üé§</div>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:-25px; z-index:20;">
            <button id="l-mic" class="btn" onclick="toggleMic()">üé§</button>
            <button id="l-vid" class="btn" onclick="toggleVid()">üì∑</button>
        </div>
        <input type="text" id="user-name" placeholder="–¢–≤–æ–π –Ω–∏–∫" style="padding:10px; border-radius:8px; border:none; width:250px;">
        <input type="text" id="room-name" placeholder="–ö–æ–º–Ω–∞—Ç–∞" style="padding:10px; border-radius:8px; border:none; width:250px;">
        <button class="btn-join" onclick="joinRoom()">–ó–∞–π—Ç–∏</button>
    </div>

    <div id="room">
        <div id="video-grid"></div>
        <div class="bottom-bar">
            <button id="r-mic" class="btn" onclick="toggleMic()">üé§</button>
            <button id="r-vid" class="btn" onclick="toggleVid()">üì∑</button>
            <button id="r-screen" class="btn btn-screen" onclick="toggleScreen()">üñ•Ô∏è</button>
            <button class="btn" style="background:var(--danger);" onclick="location.reload()">üìû</button>
        </div>
    </div>

<script>
    let myStream;
    let currentScreenStream;
    let isMic = true;
    let isVid = true;
    let isSharing = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
        myStream = stream;
        document.getElementById('preview-video').srcObject = stream;
    });

    function toggleMic() {
        isMic = !isMic;
        if (myStream) myStream.getAudioTracks()[0].enabled = isMic;
        updateUI();
    }

    function toggleVid() {
        isVid = !isVid;
        if (myStream) myStream.getVideoTracks()[0].enabled = isVid;
        updateUI();
    }

    // –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê
    async function toggleScreen() {
        if (!isSharing) {
            try {
                currentScreenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                isSharing = true;
                
                // –ú–µ–Ω—è–µ–º –≤–∏–¥–µ–æ –≤ —Å–≤–æ–µ–º –±–æ–∫—Å–µ
                const myVideo = document.querySelector('#me video');
                if (myVideo) {
                    myVideo.srcObject = currentScreenStream;
                    myVideo.classList.remove('mirror'); // –≠–∫—Ä–∞–Ω –Ω–µ –Ω–∞–¥–æ –∑–µ—Ä–∫–∞–ª–∏—Ç—å
                }
                
                document.getElementById('r-screen').classList.add('active');

                // –ï—Å–ª–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
                currentScreenStream.getVideoTracks()[0].onended = () => stopScreenShare();
            } catch (e) { console.error(e); }
        } else {
            stopScreenShare();
        }
    }

    function stopScreenShare() {
        isSharing = false;
        if (currentScreenStream) {
            currentScreenStream.getTracks().forEach(track => track.stop());
        }
        const myVideo = document.querySelector('#me video');
        if (myVideo) {
            myVideo.srcObject = myStream;
            myVideo.classList.add('mirror');
        }
        document.getElementById('r-screen').classList.remove('active');
    }

    function updateUI() {
        document.querySelectorAll('#l-mic, #r-mic').forEach(b => b.classList.toggle('off', !isMic));
        document.querySelectorAll('#l-vid, #r-vid').forEach(b => b.classList.toggle('off', !isVid));
        
        const lobbyMic = document.getElementById('lobby-mic-status');
        lobbyMic.innerText = isMic ? "üé§" : "üîá";
        lobbyMic.classList.toggle('icon-off', !isMic);
        document.getElementById('lobby-box').classList.toggle('video-off', !isVid);

        const myBox = document.getElementById('me');
        if (myBox) {
            myBox.classList.toggle('video-off', !isVid);
            const micIcon = myBox.querySelector('.icon');
            micIcon.innerText = isMic ? "üé§" : "üîá";
            micIcon.classList.toggle('icon-off', !isMic);
        }
    }

    function joinRoom() {
        const room = document.getElementById('room-name').value;
        const name = document.getElementById('user-name').value || "–ë—Ä–æ";
        if (!room) return alert("–í–≤–µ–¥–∏ –∫–æ–º–Ω–∞—Ç—É!");

        document.getElementById('lobby').style.display = 'none';
        document.getElementById('room').style.display = 'flex';

        const myPeer = new Peer(`${name}-${room}-${Math.floor(Math.random()*999)}`);
        
        createVideoBox(myStream, name + " (–í—ã)", 'me', true);
        updateUI();

        myPeer.on('call', call => {
            call.answer(myStream);
            call.on('stream', remoteStream => {
                createVideoBox(remoteStream, "–î—Ä—É–≥", call.peer, false);
            });
        });
    }

    function createVideoBox(stream, labelText, id, isMe) {
        if (document.getElementById(id)) return;
        const grid = document.getElementById('video-grid');
        const box = document.createElement('div');
        box.className = 'video-item';
        box.id = id;

        const v = document.createElement('video');
        v.srcObject = stream;
        v.autoplay = true;
        v.playsinline = true;
        if (isMe) v.classList.add('mirror');

        const label = document.createElement('div');
        label.className = 'name-tag';
        label.innerText = labelText;

        const icons = document.createElement('div');
        icons.className = 'status-icons';
        const mic = document.createElement('div');
        mic.className = 'icon';
        mic.innerText = "üé§";
        icons.append(mic);

        box.append(v, label, icons);
        grid.append(box);
        setupVoiceDetection(stream, id);
    }

    function setupVoiceDetection(stream, boxId) {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 64;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);

        const checkVoice = () => {
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let avg = sum / dataArray.length;
            const box = document.getElementById(boxId);
            if (box) {
                const currentMic = (boxId === 'me') ? isMic : true;
                if (avg > 25 && currentMic) box.classList.add('speaking');
                else box.classList.remove('speaking');
            }
            requestAnimationFrame(checkVoice);
        };
        checkVoice();
    }
</script>
</body>
</html>
